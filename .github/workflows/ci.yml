name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Check dist changes
        run: |
          # Only check if main JS file exists and is reasonably sized
          # Sourcemaps can vary between environments, so we don't do strict diff
          if [ ! -f "dist/index.js" ]; then
            echo "dist/index.js not found after build"
            exit 1
          fi

          # Check if there are significant changes (ignore sourcemaps)
          if git diff --stat dist/index.js | grep -q "insertions\|deletions"; then
            echo "Warning: dist/index.js has changes. If you modified source, please run 'npm run build' and commit."
            git diff --stat dist/index.js
          fi

          echo "Build verification passed"

  test:
    name: Test Action
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create test package.json
        run: |
          mkdir -p test-project
          cat > test-project/package.json << 'EOF'
          {
            "name": "test-project",
            "version": "1.0.0",
            "dependencies": {
              "express": "^4.18.0",
              "lodash": "^4.17.21"
            }
          }
          EOF

      - name: Run action on clean project
        uses: ./
        with:
          working-directory: test-project
          fail-on-critical: true
          output-format: text

      - name: Verify clean status
        run: echo "Clean project test passed"

  test-detection:
    name: Test Detection
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create test package.json with affected package
        run: |
          mkdir -p test-affected
          cat > test-affected/package.json << 'EOF'
          {
            "name": "test-affected",
            "version": "1.0.0",
            "dependencies": {
              "posthog-node": "^5.0.0"
            }
          }
          EOF

      - name: Run action on affected project (should fail)
        id: detect
        uses: ./
        with:
          working-directory: test-affected
          fail-on-critical: true
          output-format: json
        continue-on-error: true

      - name: Verify detection
        run: |
          if [ "${{ steps.detect.outcome }}" != "failure" ]; then
            echo "Expected action to fail but it succeeded"
            exit 1
          fi
          echo "Detection test passed - action correctly identified compromised package"
